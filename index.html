<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="./confetti.js"></script>
    <script src="./birthday_clock.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="robol_bday.css">
    <link rel="stylesheet" href="night_sky.css">
    <iframe src="silence.mp3" allow="autoplay" id="audio" style="display: none"></iframe>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

</head>

<body class="gradient">

    <div id="confetti">
    </div>
    <center>
        <p class="fnt" id="hepi-berzdej-timer"></p>
        <p class="fnt" id="robolenie">(robolenie ðŸŽ‚ in progress)</p>
    </center>



</body>


<script>

   let countDownDate = new Date("September 25, 2022 22:14:00").getTime();
   let now = new Date().getTime();
   
   //game variables
   let PI = Math.PI
   let fps = 60
   let fpsCount = 60
   let eatenMaxikingCount = 0
   let isOnionKing = false
   let canKillU = false
   let collided = false
   let glud = 5
   let difficulty = 4
   let difficultyCounter = 0
   let gameStarted = false
   let robolHitboxSize = 93

    //Object positons
   let mouseX = 0
   let mouseY = 0
   let robolX = 0
   let robolY = 0
   let robolBobbing = 0
   let maxikingX = Math.floor(Math.random() * 800) + 100
   let maxikingY = Math.floor(Math.random() * 600)


    birthday_clock()


    function disableConfetti(){
        $("#confetti").remove()
    }

    function killGame(deathBy){
        gameStarted = false
        //setting css for death text
        $("#pipcia").css("margin-top", "18vh")
        $("#pipcia").css("color", "red")
        $("#pipcia").css("font-size", "5vw")
        $("body").css("cursor", "auto")
        $(".game-element").remove()
        if (deathBy == "HUNGER")
            $("#pipcia").text("O nie! Piziu, robol mega zgÅ‚odniaÅ‚ i go zmiotÅ‚o z planszy!");
        

        if(deathBy == "ONION_KING")
            $("#pipcia").text("O nie! Piziu, robol zjadÅ‚ onion kinga i go zmiotÅ‚o z planszy!");
        
        
    }

    function updateHungerBar() {

        if (glud > 5) {
            glud = 5
            $("#glud").text("pojedzon")
        }
        if (glud >= 5) {
            $("#glud").text("pojedzon")
        }
        if (glud <= 4) {
            $("#glud").text("pojedzon?")
        }
        if (glud <= 3) {
            $("#glud").text("karm")
        }
        if (glud <= 2) {
            $("#glud").text("pls")
        }
        if (glud <= 1) {
            $("#glud").text("KURWA KARM")
        }
        if (glud <= -1) {
            killGame(deathBy="HUNGER")
        }

        $("#robol-bar").attr("value", glud)
        
    }

    function updateRobolPos(mouseX, mouseY) {
        mouseX = mouseX - 50
        mouseY = (mouseY - 50)

        if  (robolX > mouseX) {
            if  (robolX - mouseX < 15)
             robolX = robolX - 0.5
            else if  (robolX - mouseX < 80)
             robolX = robolX - 10
            else
             robolX = robolX - 50

            $("#robol").removeClass('flipped');

        }

        if  (robolX < mouseX) {
            if (mouseX - robolX < 15)
             robolX = robolX + 0.5
            else if (mouseX - robolX < 80)
             robolX = robolX + 10
            else
             robolX = robolX + 50

            $("#robol").addClass('flipped');
        }

        //robolY
        if (robolY > mouseY) {
            if (robolY - mouseY < 15)
                robolY = robolY - 0.5
            else if (robolY - mouseY < 80)
                robolY = robolY - 10
            else
                robolY = robolY - 50
        }


        if (robolY < mouseY) {
            if (mouseY - robolY < 15)
                robolY = robolY + 0.5
            else if (mouseY - robolY < 80)
                robolY = robolY + 10
            else
                robolY = robolY + 50
        }


        $("#robol").css({
            left: robolX,
            top: robolY
        });

        $("#robol-bar").css({
            left: robolX-15,
            top: robolY-15
        });

        $("#glud").css({
            left: robolX,
            top: robolY-55,
        });


    }

    function updateRobolBobbing(){
        robolBobbing += 0.02*PI
        if(robolBobbing > 4*PI) 
            robolBobbing = 0;
        console.log(robolBobbing)
        return Math.sin(robolBobbing)*5
    }

    function checkRobolMaxikingCollision() {

        if  (robolX > maxikingX || robolX + robolHitboxSize > maxikingX) {
            if  (robolX < maxikingX + robolHitboxSize || robolX + robolHitboxSize < maxikingX + robolHitboxSize) {
                if (robolY > maxikingY || robolY + robolHitboxSize > maxikingY) {
                    if (robolY < maxikingY + robolHitboxSize || robolY + robolHitboxSize < maxikingY + robolHitboxSize)
                        collided = true
                }
            }
        }

        if (collided && gameStarted) {
            
            if (canKillU) 
                killGame(deathBy = "ONION_KING");
        
            respawnMaxiKing(robolX, robolY)

            eatenMaxikingCount += 1
            $("#pipi").text("Zjedzone maxi king: " + eatenMaxikingCount)

            if (Math.floor(Math.random() * 10) < 2) 
                glud += 2;
            else 
                glud += 1;

            }
            collided = false
        }

    function spawnGameElements(){
        $("hepi-berzdej-timer").remove()
        $("#lol").remove()
        $(".fnt").remove()
        $("#start-button").remove()
        $("button").remove()
        disableConfetti()
        dtval = 8.0
        $(".cizia").css("width", 0)
        $(".cizia").css("height", 0)
        $(".cizia").css("display", "none")

        $("body").before('<div class="stars"></div><div class="twinkling"></div>')
        $('body').removeClass('gradient')
        $("body").prepend('<div class="backdrop"></div>')
        //<div id="foglayer_01" class="fog"><div class="image01"></div><div class="image02"></div></div><div id="foglayer_02" class="fog"><div class="image01"></div><div class="image02"></div></div><div id="foglayer_03" class="fog"><div class="image01"></div><div class="image02"></div></div>
        $(".backdrop").prepend('<meter id="robol-bar" low="2" high="5" optimum="3" value="5" max="5" min="-1"></meter><div id="robol"><img src="./assets/halloween-robol.png"/></div>')
        

        $(".backdrop").prepend('<img class="maxiking" src="./assets/maxiking.png"/>')
        
        $(".backdrop").prepend('<h1 id="pipcia" style="color: #66ffff70; margin-top: 8px;">(nie jedz onion kinga bo cb zmiecie z planszy!!!)</h1>')
        $(".backdrop").prepend('<h1 id="pipi" class="fnt" margin-top: 10px">Zjedzone maxi king: 0</h1>')
        $(".backdrop").prepend('<p class="fnt" id="glud"></p>')

        //instantiate game elemetns
        $(".maxiking").addClass("game-element")
        $("#robol-bar").addClass("game-element")
        $(".robol").addClass("game-element")
        $("#glud").addClass("game-element")
        $("#glud").text("pojedzon")
        $(".maxiking").css({
            left: maxikingX,
            top: maxikingY,
            width: 100,
            height: 100
        });
        $("body").css("cursor", "none")
    }

    function respawnMaxiKing(playerX, playerY){
        maxikingX = Math.floor(Math.random() * 800)
        maxikingY = Math.floor(Math.random() * 600)

        let onionChance = Math.floor(Math.random() * 10)

        if (onionChance < difficulty) {
            isOnionKing = true
            canKillU = true
            $(".maxiking").attr("src", "./assets/onionking.png")
                    
        } else {
            isOnionKing = false
            canKillU = false
            $(".maxiking").attr("src", "./assets/maxiking.png")
        }

        $(".maxiking").css({
            left: maxikingX,
            top: maxikingY
        });
    }
    

    function gameInit() {
        
        //Happens once before game starts
        spawnGameElements()
        gameStarted = true

        $(document).ready(function (e) {
            mouseX = e.pageX
            mouseY = e.pageY
        })

        robolX = mouseX
        robolY = mouseY

        
        //GAME LOOP
        setInterval(function () {
            
            //Make something happen practically instantly
            if (gameStarted){
            
                glud -= 0.01
                fpsCount += 1
                updateRobolPos(mouseX, mouseY+updateRobolBobbing());
                checkRobolMaxikingCollision()
                updateHungerBar()
                

                //Make something happen every second
                if (fpsCount > fps) {
                    //game, time-based logic
                    fpsCount = 0
                    difficultyCounter += 1

                    if (difficultyCounter >= 2000 && difficulty < 4) 
                        difficulty += 1
                    //what the fuck -> $("#pipcia").css("color", "#66ffff30")  
                }
            }
        }, 16.666666667);
    }

    //handle game mouse movement events
    $(document).on('mousemove', function (e) {
        mouseX = e.pageX
        mouseY = e.pageY
    })

    //handle game click events
    $(window).click(function () {
            if (isOnionKing) 
                respawnMaxiKing(robolX, robolY)
    })


</script>